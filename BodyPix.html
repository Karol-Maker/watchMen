<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detecção de pessoas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix@2.0/dist/body-pix.min.js"></script>
    <style>
        video, canvas {
          border-radius: 0.5rem;
          box-shadow: 0 4px 6px rgba(0,0,0,0.2);
          max-width: 100%;
        }
      </style>
    </head>
    <body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4">
    
      <h1 class="text-2xl font-bold text-gray-800 mb-4">Detecção Automática de Pessoas</h1>
      <p id="status" class="mb-4 text-gray-600">Carregando modelo...</p>
    
      <video id="video" autoplay playsinline muted class="hidden"></video>
      <canvas id="output" width="640" height="480"></canvas>
    
      <script>
        const video = document.getElementById("video");
        const canvas = document.getElementById("output");
        const ctx = canvas.getContext("2d");
        const statusDiv = document.getElementById("status");
    
        let model;
    
        // Função de ajuste automático de brilho e contraste
        function autoEnhance(ctx, width, height) {
          const frame = ctx.getImageData(0, 0, width, height);
          const data = frame.data;
    
          let min = 255, max = 0;
          for (let i = 0; i < data.length; i += 4) {
            const v = 0.2126 * data[i] + 0.7152 * data[i+1] + 0.0722 * data[i+2]; // luminância
            if (v < min) min = v;
            if (v > max) max = v;
          }
    
          const scale = 255 / (max - min + 1);
          const offset = -min * scale;
    
          for (let i = 0; i < data.length; i += 4) {
            data[i] = Math.min(255, Math.max(0, data[i] * scale + offset));
            data[i+1] = Math.min(255, Math.max(0, data[i+1] * scale + offset));
            data[i+2] = Math.min(255, Math.max(0, data[i+2] * scale + offset));
          }
    
          ctx.putImageData(frame, 0, 0);
        }
    
        async function setupCamera() {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { width: 640, height: 480 }
          });
          video.srcObject = stream;
          return new Promise((resolve) => {
            video.onloadedmetadata = () => resolve(video);
          });
        }
    
        async function loadModel() {
          statusDiv.textContent = "Carregando modelo BodyPix...";
          model = await bodyPix.load({
            architecture: "MobileNetV1",
            outputStride: 16,
            multiplier: 0.75,
            quantBytes: 2
          });
          statusDiv.textContent = "Modelo carregado. Detectando pessoas...";
        }
    
        async function detectFrame() {
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    
          // Ajuste automático de iluminação no frame
          autoEnhance(ctx, canvas.width, canvas.height);
    
          const segmentation = await model.segmentPerson(canvas, {
            flipHorizontal: false,
            internalResolution: "medium",
            segmentationThreshold: 0.5
          });
    
          if (segmentation.allPoses.length > 0) {
            statusDiv.textContent = "Pessoa detectada!";
            const mask = bodyPix.toMask(segmentation, 
              { r: 255, g: 255, b: 255, a: 180 }, // pessoa branca
              { r: 0, g: 0, b: 0, a: 0 }          // fundo transparente
            );
            bodyPix.drawMask(canvas, video, mask, 0.7, 0, false);
          } else {
            statusDiv.textContent = "Nenhuma pessoa detectada.";
          }
    
          requestAnimationFrame(detectFrame);
        }
    
        async function main() {
          await setupCamera();
          await loadModel();
          detectFrame();
        }
    
        main();
      </script>
    </body>
    </html>
